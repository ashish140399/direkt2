<?php error_reporting(E_ALL); ini_set('display_errors',1);
    include 'config.php';
    mysqlCheck($conn);
    //include '/home/trontopia/public_html/vendor/autoload.php';
    include '../vendor/autoload.php';
    $fullNode = new \IEXBase\TronAPI\Provider\HttpProvider('https://api.trongrid.io');
    $solidityNode = new \IEXBase\TronAPI\Provider\HttpProvider('https://api.trongrid.io');
    $eventServer = new \IEXBase\TronAPI\Provider\HttpProvider('https://api.trongrid.io');
    
    try {
        $tron = new \IEXBase\TronAPI\Tron($fullNode, $solidityNode, $eventServer);
    } catch (\IEXBase\TronAPI\Exception\TronException $e) {
        exit($e->getMessage());
    }
    
    $tron->setAddress('TWfCxyMZbUKDGNtPtwLfvCaoNefVXdhZvg');
    $tron->setPrivateKey('86a954ea21d3d5142299d6bcc9b80086724c4fe1feb64166587351dec5f4f11f');
    
    $abi = '[{"constant": true,"name": "minimumMainBetAmountTRX","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "depositIntoSideBetJackpot","outputs": [{"type": "string"}],"type": "Function","payable": true,"stateMutability": "Payable"},{"name": "adminRefundBet","inputs": [{"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"}],"outputs": [{"name": "_success","type": "bool"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "calculateBetResult","inputs": [{"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"}],"outputs": [{"name": "winningNumber","type": "uint256"},{"name": "mainBetWin","type": "uint256"},{"name": "mainBetProfit","type": "uint256"},{"name": "sideBetWin","type": "uint256"},{"name": "sideBetProfit","type": "uint256"},{"name": "sideBetJackpotWinAmount","type": "uint256"},{"name": "winningNumberForSidebetJackpot","type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "updateSidebetMultipliers","inputs": [{"name": "yinMultiplier_","type": "uint256"},{"name": "yangMultiplier_","type": "uint256"},{"name": "bangMultiplier_","type": "uint256"},{"name": "zeroMultiplier_","type": "uint256"},{"name": "oddMultiplier_","type": "uint256"},{"name": "evenMultiplier_","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "updateDividendThreshold","inputs": [{"name": "_dividendThreshold","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "jackpotSizePercentageToDividendPool","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "blockHashes","inputs": [{"type": "uint256"}],"outputs": [{"type": "bytes32"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "ownerRakePool","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "calculateBetHash","inputs": [{"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"}],"outputs": [{"type": "bytes32"}],"type": "Function","stateMutability": "Pure"},{"name": "updateTopiaTokenContractAddress","inputs": [{"name": "_newAddress","type": "address"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "totalDepositedTRX","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "dividendContractAddress","outputs": [{"type": "address"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "getBlockNumber","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "updateSideBetJackpot","inputs": [{"name": "_sideBetJackpotMaxOdd","type": "uint256"},{"name": "_sideBetJackpotFixNumber","type": "uint256"},{"name": "_sideBetAmountTRXtoQualifyForMaximumJackpot","type": "uint256"},{"name": "_maximumPercentageOfJackpotSizeWon","type": "uint256"},{"name": "_sideBetLossPercentageForProgressiveJackpot","type": "uint256"},{"name": "_jackpotSizePercentageToDividendPool","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "depositTRX","outputs": [{"type": "string"}],"type": "Function","payable": true,"stateMutability": "Payable"},{"name": "updateMaxBetMaxWin","inputs": [{"name": "maxBetAmount_","type": "uint256"},{"name": "maxWinDivisibleAmount_","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "storeBlockHashesRange","inputs": [{"name": "_firstBlockNumber","type": "uint256"},{"name": "_lastBlockNumber","type": "uint256"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "updateDividendContractAddress","inputs": [{"name": "_newAddress","type": "address"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "finishManyBets","inputs": [{"name": "_gambler","type": "address[]"},{"name": "_uniqueBetId","type": "bytes32[]"},{"name": "_userSeed","type": "bytes32[]"},{"name": "_blockNumber","type": "uint256[]"},{"name": "_rollIntegerVariables","type": "uint256[5][]"},{"name": "_lowLevelGas","type": "uint256"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "topiaTokenContractAddress","outputs": [{"type": "address"}],"type": "Function","stateMutability": "View"},{"name": "withdrawDepositedJackpot","inputs": [{"name": "_amountSun","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "maximumPercentageOfJackpotSizeWon","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "unfinishedBetHash_to_timestamp","inputs": [{"type": "bytes32"}],"outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "manualWithdrawTRX","inputs": [{"name": "amount","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "acceptOwnership","type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "systemHalted","outputs": [{"type": "bool"}],"type": "Function","stateMutability": "View"},{"name": "setBetExpiredBehaviour","inputs": [{"name": "_betExpiredBehaviour","type": "uint256"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "updateMinimumSideBetAmount","inputs": [{"name": "minimumSideBetAmountTRX_","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "user_to_lastBetHash","inputs": [{"type": "address"}],"outputs": [{"type": "bytes32"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "totalTRXbalanceContract","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "ownerRakePerMillion","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "finishBet_and_startBet","inputs": [{"name": "_finishBet_gambler","type": "address"},{"name": "_finishBet_uniqueBetId","type": "bytes32"},{"name": "_finishBet_userSeed","type": "bytes32"},{"name": "_finishBet_blockNumber","type": "uint256"},{"name": "_finishBet_rollIntegerVariables","type": "uint256[5]"},{"name": "_startBet_rollIntegerVariables","type": "uint256[5]"},{"name": "_startBet_referrer","type": "address"},{"name": "_startBet_userSeed","type": "bytes32"},{"name": "_startBet_uniqueBetId","type": "bytes32"}],"type": "Function","payable": true,"stateMutability": "Payable"},{"name": "storeAllRecentBlockHashes","type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "sideBetLossPercentageForProgressiveJackpot","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "dividendThreshold","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "withdrawPartOfRakePool","inputs": [{"name": "amount","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "storeCertainBlockHashes","inputs": [{"name": "_blockNumbers","type": "uint256[]"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "requestDividendPayment","inputs": [{"name": "dividendAmount","type": "uint256"}],"outputs": [{"type": "bool"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "updateMinimumMainBetAmount","inputs": [{"name": "minimumMainBetAmountTRX_","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "currentSideBetJackpotSize","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "setSystemHalted","inputs": [{"name": "_systemHalted","type": "bool"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "updateRakePerMillion","inputs": [{"name": "_newRakePerMillion","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "maxBetAmount","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "finishBet","inputs": [{"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "calculateBetResultWithBlockHash","inputs": [{"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"},{"name": "_blockHash","type": "bytes32"}],"outputs": [{"name": "winningNumber","type": "uint256"},{"name": "mainBetWin","type": "uint256"},{"name": "mainBetProfit","type": "uint256"},{"name": "sideBetWin","type": "uint256"},{"name": "sideBetProfit","type": "uint256"},{"name": "sideBetJackpotWinAmount","type": "uint256"},{"name": "winningNumberForSidebetJackpot","type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "sideBetAmountTRXtoQualifyForMaximumJackpot","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "minimumSideBetAmountTRX","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "setMultiplierData","inputs": [{"name": "data","type": "uint256[]"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "withdrawFullRakePool","outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"name": "startBet","inputs": [{"name": "_rollIntegerVariables","type": "uint256[5]"},{"name": "_referrer","type": "address"},{"name": "_userSeed","type": "bytes32"},{"name": "_uniqueBetId","type": "bytes32"}],"outputs": [{"name": "_newUnfinishedBetHash","type": "bytes32"}],"type": "Function","payable": true,"stateMutability": "Payable"},{"constant": true,"name": "getBlockHash","inputs": [{"name": "_blockNumber","type": "uint256"}],"outputs": [{"type": "bytes32"}],"type": "Function","stateMutability": "View"},{"name": "transferOwnership","inputs": [{"name": "_newOwner","type": "address"}],"type": "Function","stateMutability": "Nonpayable"},{"constant": true,"name": "displayAvailableDividend","outputs": [{"type": "bool"},{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"constant": true,"name": "totalDepositedIntoJackpot","outputs": [{"type": "uint256"}],"type": "Function","stateMutability": "View"},{"name": "manualWithdrawTokens","inputs": [{"name": "tokenAmount","type": "uint256"}],"outputs": [{"type": "string"}],"type": "Function","stateMutability": "Nonpayable"},{"type": "Constructor","stateMutability": "Nonpayable"},{"type": "Fallback","payable": true,"stateMutability": "Payable"},{"name": "BetStarted","inputs": [{"indexed": true,"name": "_betHash","type": "bytes32"},{"indexed": true,"name": "_gambler","type": "address"},{"name": "_uniqueBetId","type": "bytes32"},{"name": "_userSeed","type": "bytes32"},{"indexed": true,"name": "_blockNumber","type": "uint256"},{"name": "_rollIntegerVariables","type": "uint256[5]"}],"type": "Event"},{"name": "BetFinished","inputs": [{"indexed": true,"name": "_betHash","type": "bytes32"}],"type": "Event"},{"name": "BetExpired","inputs": [{"name": "betHash","type": "bytes32"},{"name": "user","type": "address"},{"name": "betAmount","type": "uint256"}],"type": "Event"},{"name": "BetRefunded","inputs": [{"indexed": true,"name": "_betHash","type": "bytes32"},{"indexed": true,"name": "_gambler","type": "address"},{"name": "_amountRefunded","type": "uint256"}],"type": "Event"},{"name": "Roll","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_startNumber","type": "uint256"},{"name": "_endNumber","type": "uint256"},{"name": "_winningNumber","type": "uint256"},{"indexed": true,"name": "_value","type": "uint256"},{"indexed": true,"name": "result","type": "bool"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "KingTopian","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_prize","type": "uint256"},{"name": "_trxplayed","type": "uint256"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "UnluckyBunch","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_loose","type": "uint256"},{"name": "_trxplayed","type": "uint256"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "HighRollers","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_startNumber","type": "uint256"},{"name": "_endNumber","type": "uint256"},{"name": "_winningNumber","type": "uint256"},{"name": "_value","type": "uint256"},{"name": "_winamount","type": "uint256"},{"name": "result","type": "bool"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "RareWins","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_startNumber","type": "uint256"},{"name": "_endNumber","type": "uint256"},{"name": "_winningNumber","type": "uint256"},{"name": "_value","type": "uint256"},{"name": "_winamount","type": "uint256"},{"name": "result","type": "bool"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "SideBetRolls","inputs": [{"indexed": true,"name": "user","type": "address"},{"name": "_winningNumber","type": "uint256"},{"name": "_betValue","type": "uint256"},{"name": "winAmount","type": "uint256"},{"name": "sideBet","type": "uint256"},{"name": "result","type": "bool"},{"name": "timestamp","type": "uint256"}],"type": "Event"},{"name": "SideBetJackpot","inputs": [{"indexed": true,"name": "winner","type": "address"},{"name": "lukyNumber","type": "uint256"},{"name": "jackpotAmount","type": "uint256"}],"type": "Event"},{"name": "OwnershipTransferred","inputs": [{"indexed": true,"name": "_from","type": "address"},{"indexed": true,"name": "_to","type": "address"}],"type": "Event"}]';
        
    $abi = json_decode($abi,true);
    //contract address in hex
    $contract = '411648404Ef772771C8d1eFEf4f9E025a9bbA7B18C';
    $function = 'finishManyBets';
    $gambler = array();
    $betID = array();
    $userSeed = array();
    $blockNUmbers = array();
    $rollIntVariables = array();
    $lowlevelGas = 10000000;
    
    $sql = "SELECT * FROM `betStarted` WHERE `newUnfinishedBetHash` NOT IN (SELECT `betHash` FROM `betFinished`) order by id DESC limit 0,10";    
    $res = mysqli_query($conn,$sql);
    mysqli_close($conn);
    if(mysqli_num_rows($res)>0){
        while($row = mysqli_fetch_array($res)){
            $user = str_replace('0x', '41', $row['user']);
            $user = $tron->fromHex($user);
         array_push($gambler,$user);
         array_push($betID,'0x'.$row['uniqueBetId']);
         array_push($userSeed,'0x'.$row['userSeed']);
         array_push($blockNUmbers,$row['blockNumber']);
         $rollIntegerVariables = $row['rollIntegerVariables'];
            // $start = hexdec(substr($rollIntegerVariables,2*64,64));
             //$end = hexdec(substr($rollIntegerVariables,3*64,64));
             //$betAmount = hexdec(substr($rollIntegerVariables,4*64,64));
             //$sidebetAmount = hexdec(substr($rollIntegerVariables,5*64,64));
             //$sidebetInt =  hexdec(substr($rollIntegerVariables,6*64,64));
           
            $start = '0x'.substr($rollIntegerVariables,2*64,64);
            $end = '0x'.substr($rollIntegerVariables,3*64,64);
            $betAmount = '0x'.substr($rollIntegerVariables,4*64,64);
            $sidebetAmount = '0x'.substr($rollIntegerVariables,5*64,64);
            $sidebetInt =  '0x'.substr($rollIntegerVariables,6*64,64);
            $rollArray = array($start,$end,$betAmount,$sidebetAmount,$sidebetInt);

             array_push($rollIntVariables,$rollArray);
        }
        $params = array($gambler,$betID,$userSeed,$blockNUmbers,$rollIntVariables,$lowlevelGas);
        //$params  = array(array('TDCzcjMUWwpeWsMwbLJxNmHwL7zRZJkCh1'),array('0x60f35afc8fd84ed44616cf4ce34dfa85dd84afa40fc9a3d9f3c3e35068dfcc39'),array('0x60f35afc8fd84ed44616cf4ce34dfa85dd84afa40fc9a3d9f3c3e35068dfcc39'),array('9498863'),array(array(hexdec('0x000000000000000000000000000000000000000000000000000000000000000e'),hexdec('0x0000000000000000000000000000000000000000000000000000000000000059'),hexdec('0x0000000000000000000000000000000000000000000000000000000000000190'),hexdec('0x0000000000000000000000000000000000000000000000000000000000000000'),hexdec('0x0000000000000000000000000000000000000000000000000000000000000000'))),10000000);
       // print_r($params);
        //exit;
        $feeLimit = 10000000;
        $callValue = 0;
        //user address who calling function
        $address = '41e2f31FC61c04d462FD7b3Dc8A8aEAAc765B8A10B';
        
       // print_r($params);
        
        try {
            $triggerContract = $tron->triggerContract($abi,$contract,$function,$params,$feeLimit,$address,$callValue ,$bandwidthLimit = 10);
        	var_dump($triggerContract);
            $signedTransaction = $tron->signTransaction($triggerContract);
            $response = $tron->sendRawTransaction($signedTransaction);
            var_dump($response);
        } catch (\IEXBase\TronAPI\Exception\TronException $e) {
            die($e->getMessage());
        }
    }
    
?>